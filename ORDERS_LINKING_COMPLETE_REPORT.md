# ๐ ุชูุฑูุฑ ุญู ูุดููุฉ ุงูุทูุจูุงุช ุงูููุงุฆู

## ุงููุดููุฉ ุงูุฃุตููุฉ โ
ุงูุทูุจูุงุช ูุณุฌูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุชุธูุฑ ูู dashboard) ููู **ูุง ุชุธูุฑ ูููุณุชุฎุฏููู** ูู ุตูุญุฉ "ุทูุจุงุชู"

---

## ุงูุณุจุจ ุงูุฌุฐุฑู ๐

### ุซูุงุซ ูุดุงูู ูุชุฏุงุฎูุฉ:

1. **Ordering Model Mismatch**
   - ุงูุทูุจูุงุช ุงูุถูู (guest): `user_id = NULL`, `guest_email = filled`
   - ุงูุทูุจูุงุช ุงููุณุฌูุฉ: `user_id = filled`, `guest_email = NULL`
   - ุนูุฏ ุชุณุฌูู ุงููุณุชุฎุฏูุ ุงูุทูุจูุงุช ุงููุฏููุฉ ูู ุชูุฑุจุท

2. **Missing RLS UPDATE Policy**
   - ูุงู ููุงู SELECT ู INSERT policies
   - ููู **ูุง ุชูุฌุฏ UPDATE policy** ููุณูุงุญ ุจุชุญุฏูุซ ุงูุทูุจูุงุช
   - ุงููุณุชุฎุฏู ูุง ูุณุชุทูุน ุฑุจุท ุทูุจูุงุชู

3. **Frontend Implementation**
   - ุงูุฒุฑ ูุงู ูุญุงูู ุงูุฌูุจ ุงููุจุงุดุฑ ูู Supabase
   - ููู RLS ุชููุน ูุฐุง

---

## ุงูุญู ุงูููุงุฆู โ

### 1. ุฅุถุงูุฉ RLS UPDATE Policy
**ุงูููู**: `scripts/002-rls-policies.sql` ู `scripts/012-fix-guest-order-rls.sql`

```sql
DROP POLICY IF EXISTS "Users can update own orders" ON orders;
CREATE POLICY "Users can update own orders" ON orders 
  FOR UPDATE 
  USING (auth.uid() = user_id OR user_id IS NULL OR is_admin()) 
  WITH CHECK (auth.uid() = user_id OR user_id IS NULL OR is_admin());
```

**ูุงุฐุง ููุนู:**
- ูุณูุญ ูููุณุชุฎุฏู ุจุชุญุฏูุซ ุทูุจุงุชู ุงูุฎุงุตุฉ
- ูุณูุญ ุจุชุญุฏูุซ ุงูุทูุจูุงุช ุงูุถูู (user_id IS NULL)
- ูุณูุญ ููู admins ุจุชุญุฏูุซ ุฃู ุดูุก

### 2. API Endpoint ููุฑุจุท
**ุงูููู**: `app/api/account/orders/link/route.ts` (ุฌุฏูุฏ)

```typescript
POST /api/account/orders/link
Body: { orderIds: ["id1", "id2", ...] }
```

**ูุง ุงูุฐู ููุนูู:**
- ูุชุญูู ูู ุชุณุฌูู ุงููุณุชุฎุฏู
- ูุณุชุฎุฏู admin client ูุถูุงู ุงููุฌุงุญ
- ูุญุฏูุซ ููุท ุงูุทูุจูุงุช ุจู `user_id = NULL`
- ูุนููู `user_id = auth.uid()`

### 3. ุชุญุณููุงุช ุงููุงุฌูุฉ
**ุงูููู**: `app/account/orders/page.tsx`

**ุงูููุฒุงุช:**
- ๐ ูุดู ุงูุทูุจูุงุช ุงูุถูู ุชููุงุฆูุงู
- ๐ ุฒุฑ ุฑุจุท ูุน ุญุงูุงุช ุชุญููู
- โ ุฑุณุงุฆู ูุฌุงุญ ูุฎุทุฃ ูุงุถุญุฉ
- ๐ ุชุญุฏูุซ ุชููุงุฆู ุจุนุฏ ุงูุฑุจุท

### 4. ุฑุจุท ุชููุงุฆู ุนูุฏ ุงูุชุณุฌูู
**ุงูููู**: `app/register/page.tsx`

```typescript
// ุนูุฏ ุงูุชุณุฌูู
const { error: updateError } = await supabase
  .from("orders")
  .update({ user_id: data.user.id })
  .ilike("guest_email", formData.email)
  .is("user_id", null)
```

**ูุง ุงูุฐู ููุนูู:**
- ุงููุณุชุฎุฏููู ุงูุฌุฏุฏ ุชูุฑุจุท ุทูุจุงุชูู ุชููุงุฆูุงู ุนูุฏ ุงูุชุณุฌูู
- ูุง ุญุงุฌุฉ ููุถุบุท ุนูู ุฒุฑ

---

## ุณูุฑ ุงูุนูู ุงููุงูู

### ุงูุณููุงุฑูู 1: ูุณุชุฎุฏู ุฌุฏูุฏ
```
1. ุถุน ุทูุจูุฉ โ user_id = NULL, guest_email = "user@example.com"
2. ุณุฌู ุญุณุงุจูุง ุจููุณ ุงูุจุฑูุฏ
3. โ ุงูุชุทุจูู ูุฑุจุท ุงูุทูุจูุงุช ุชููุงุฆูุงู
4. ุงุฐูุจ ูู /account/orders โ ุงูุทูุจูุงุช ุชุธูุฑ ูุจุงุดุฑุฉ
```

### ุงูุณููุงุฑูู 2: ูุณุชุฎุฏู ููุฌูุฏ ุจุทูุจูุงุช ุถูู
```
1. ูุงู ูุถุน ุทูุจูุงุช ูุถูู
2. ุณุฌู ุญุณุงุจูุง (ุฑุจูุง ุจุนูุฑู)
3. ุงุฐูุจ ูู /account/orders
4. ุชุฑู: "Found X previous orders as guest"
5. ุงุถุบุท ุงูุฒุฑ "Link X orders to my account"
6. โ ูุธูุฑ ุชูุจูู ุงููุฌุงุญ
7. ุงูุตูุญุฉ ุชูุญุฏูุซ โ ุงูุทูุจูุงุช ุชุธูุฑ
```

### ุงูุณููุงุฑูู 3: ูุณุชุฎุฏู ูุน ุทูุจูุงุช ููุฌูุฏุฉ
```
1. ุงุฐูุจ ูู /account/orders
2. ุชุฑู ุทูุจูุงุชู ูุจุงุดุฑุฉ
3. ูุง ุชูุฌุฏ ุฑุณุงูุฉ ุฑุจุท (ุฌููุน ุงูุทูุจูุงุช ูุฑุชุจุทุฉ)
4. โ ูู ุดูุก ุนุงุฏู
```

---

## ุงููููุงุช ุงููุนุฏูุฉ

| ุงูููู | ุงูุญุงูุฉ | ุงููุตู |
|------|--------|--------|
| `app/api/account/orders/link/route.ts` | โ ุฌุฏูุฏ | API endpoint ููุฑุจุท |
| `app/account/orders/page.tsx` | โ ูุญุฏูุซ | ูุงุฌูุฉ ูุญุณููุฉ + ุฑุจุท ูุฏูู |
| `app/register/page.tsx` | โ ูุญุฏูุซ | ุฑุจุท ุชููุงุฆู ุนูุฏ ุงูุชุณุฌูู |
| `app/api/account/orders/route.ts` | โ ูุญุฏูุซ | logging ูุญุณูู |
| `scripts/002-rls-policies.sql` | โ ูุญุฏูุซ | ุฅุถุงูุฉ UPDATE policy |
| `scripts/012-fix-guest-order-rls.sql` | โ ูุญุฏูุซ | ุฅุถุงูุฉ UPDATE policy |
| `scripts/017-fix-guest-order-linking.sql` | โ ุฌุฏูุฏ | ุฅุตูุงุญ ูุชุฎุตุต |

---

## ุงูุชุทุจูู ุงูููุฑู

### ุงูุฎุทูุฉ 1: ุชุทุจูู SQL Policy
ูู Supabase SQL Editorุ ุดุบูู:
```sql
-- ุฅุถุงูุฉ UPDATE policy ููุทูุจูุงุช
DROP POLICY IF EXISTS "Users can update own orders" ON orders;
CREATE POLICY "Users can update own orders" ON orders 
  FOR UPDATE 
  USING (auth.uid() = user_id OR user_id IS NULL OR is_admin()) 
  WITH CHECK (auth.uid() = user_id OR user_id IS NULL OR is_admin());

-- ุงุฎุชูุงุฑู: ุฅุถุงูุฉ policy ูููุตูุฉ ูุฑุจุท ุงูุทูุจูุงุช ุงูุถูู
CREATE POLICY "Users can link guest orders to own account" ON orders
  FOR UPDATE
  USING (user_id IS NULL)
  WITH CHECK (auth.uid() = user_id);
```

### ุงูุฎุทูุฉ 2: ุงุฎุชุจุงุฑ
1. ุณุฌู ูุณุชุฎุฏูุงู ุฌุฏูุฏุงู
2. ุถุน ุทูุจูุฉ (ุงุฎุชูุงุฑู - ููููู ุงุณุชุฎุฏุงู demo orders ุงูููุฌูุฏุฉ)
3. ุงุฐูุจ ูู `/account/orders`
4. ูุฌุจ ุฃู ุชุธูุฑ ุงูุทูุจูุงุช โ

---

## ุงููููุฒุงุช ุงูุฅุถุงููุฉ

### Endpoint ุงูุชุดุฎูุต
ุงุฐูุจ ุฅูู: `/api/account/orders/debug`

ูุธูุฑ JSON ูุญุชูู ุนูู:
- ูุนูููุงุช ุงููุณุชุฎุฏู
- ุฌููุน ุงูุทูุจูุงุช ูู ุงููุธุงู
- ุงูุทูุจูุงุช ุงููุฑุชุจุทุฉ ุจุงููุณุชุฎุฏู
- ุงูุทูุจูุงุช ุงูุถูู ุจููุณ ุงูุจุฑูุฏ

### Loading States
- ๐ ุญุงูุฉ ุชุญููู ุฃุซูุงุก ุงูุฑุจุท
- โ ุฑุณุงูุฉ ูุฌุงุญ ุฎุถุฑุงุก
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ
- ๐ ุชุญุฏูุซ ุชููุงุฆู ุจุนุฏ 1.5 ุซุงููุฉ

---

## ููุงุญุธุงุช ุฃูุงู

โ **ุงููุณุชุฎุฏู ูุณุชุทูุน ููุท:**
- ุฑุจุท ุงูุทูุจูุงุช ุจู `user_id = NULL` (ุทูุจูุงุช ุถูู ููุท)
- ุฑุจุท ุงูุทูุจูุงุช ุจู `guest_email` ุงูุฎุงุตุฉ ุจู

โ **API ูุชุญูู ูู:**
- ุชุณุฌูู ุงููุณุชุฎุฏู
- ุชุทุงุจู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู

โ **RLS Policy ุชุถูู:**
- ูุง ูููู ุชุญุฏูุซ ุทูุจูุงุช ุดุฎุต ุขุฎุฑ
- ูููู ููุท ุชุนููู `user_id` ูููุณู

---

## ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### ูุจู ุงูุฅุตูุงุญ โ
```
ุงููุณุชุฎุฏู ุณุฌู ุญุณุงุจูุง
โ
ุฐูุจ ูู /account/orders
โ
ุฑุฃู "No orders yet" ๐
โ
ุงูุทูุจูุงุช ููุฌูุฏุฉ ุจู user_id = NULL
โ
ูุง ุชูุฌุฏ ุทุฑููุฉ ูุฑุจุทูุง
```

### ุจุนุฏ ุงูุฅุตูุงุญ โ
```
ุงููุณุชุฎุฏู ุณุฌู ุญุณุงุจูุง
โ
ุชูุฑุจุท ุทูุจูุงุชู ุชููุงุฆูุงู
โ
ุฐูุจ ูู /account/orders
โ
ุฑุฃู ุทูุจูุงุชู ูุจุงุดุฑุฉ ๐
โ
ุฃู ุฑุฃู ุฑุณุงูุฉ "Link X orders" ุฅุฐุง ูุงูุช ุชุญุชุงุฌ ุฑุจุท ูุฏูู
โ
ุถุบุท ุงูุฒุฑ โ ุนูู! ๐
```

---

## ุงูุฎุทูุงุช ุงูุชุงููุฉ

- โ ุชุทุจูู RLS policy
- โ ุงุฎุชุจุงุฑ ุงูุฑุจุท ุงููุฏูู
- โ ุงุฎุชุจุงุฑ ุงูุฑุจุท ุงูุชููุงุฆู
- โ ุงูุชุญูู ูู ุงูุฃูุงู
- โ ุชูุซูู ุดุงููุฉ

---

**ุงูุชุงุฑูุฎ**: 21 ููุงูุฑ 2026  
**ุงูุญุงูุฉ**: โ ููุชูู ูุฌุงูุฒ ููุงุณุชุฎุฏุงู
